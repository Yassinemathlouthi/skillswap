{% extends 'base.html.twig' %}

{% block title %}Calendar - SkillSwap{% endblock %}

{% block body %}
<div class="container py-5">
    <div class="d-flex align-items-center justify-content-between mb-4">
        <h1 class="h3"><i class="fas fa-calendar-alt text-primary me-2"></i>Your Calendar</h1>
        <div>
            {% set currentDate = "now"|date('Y-m') %}
            <a href="{{ path('app_calendar_month', {'year': currentDate|date('Y'), 'month': currentDate|date('m')}) }}" class="btn btn-primary">
                <i class="fas fa-calendar me-2"></i>Month View
            </a>
            <a href="{{ path('app_calendar_all_ics') }}" class="btn btn-outline-primary ms-2">
                <i class="fas fa-download me-2"></i>Export Calendar
            </a>
        </div>
    </div>

    {% for label, messages in app.flashes %}
        {% for message in messages %}
            <div class="alert alert-{{ label }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
    {% endfor %}

    <div class="row g-4">
        <div class="col-md-4">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-white">
                    <h5 class="card-title mb-0">Quick Actions</h5>
                </div>
                <div class="card-body">
                    <div class="list-group list-group-flush">
                        <a href="{{ path('app_skills') }}" class="list-group-item list-group-item-action d-flex align-items-center">
                            <i class="fas fa-search text-primary me-3"></i>
                            <div>
                                <div class="fw-medium">Find Skills</div>
                                <small class="text-muted">Discover skills to learn</small>
                            </div>
                        </a>
                        
                        <a href="{{ path('app_sessions') }}" class="list-group-item list-group-item-action d-flex align-items-center">
                            <i class="fas fa-list text-primary me-3"></i>
                            <div>
                                <div class="fw-medium">All Sessions</div>
                                <small class="text-muted">View your upcoming and past sessions</small>
                            </div>
                        </a>
                        
                        <a href="{{ path('app_nearby') }}" class="list-group-item list-group-item-action d-flex align-items-center">
                            <i class="fas fa-map-marker-alt text-primary me-3"></i>
                            <div>
                                <div class="fw-medium">Nearby Users</div>
                                <small class="text-muted">Find skill exchanges near you</small>
                            </div>
                        </a>
                    </div>
                </div>
            </div>
            
            <div class="card shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="card-title mb-0">Sync with Other Calendars</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted small mb-4">Add your SkillSwap sessions to your favorite calendar app</p>
                    
                    <div class="d-grid gap-2">
                        <a href="{{ path('app_calendar_all_ics') }}" class="btn btn-outline-primary d-flex align-items-center justify-content-center">
                            <i class="fas fa-calendar-alt me-2"></i>
                            <span>Apple Calendar / Outlook</span>
                        </a>
                        
                        <a href="https://calendar.google.com/calendar/r/settings/addbyurl" target="_blank" class="btn btn-outline-danger d-flex align-items-center justify-content-center">
                            <i class="fab fa-google me-2"></i>
                            <span>Google Calendar</span>
                        </a>
                    </div>
                    
                    <div class="mt-3 p-3 bg-light rounded">
                        <p class="small mb-2 fw-bold">Calendar URL:</p>
                        <div class="input-group">
                            <input type="text" class="form-control form-control-sm" readonly value="{{ url('app_calendar_all_ics') }}" id="calendarUrl">
                            <button class="btn btn-sm btn-outline-secondary" type="button" onclick="copyCalendarUrl()">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                        <p class="form-text mt-2 mb-0">Use this URL to subscribe to your SkillSwap calendar in any calendar app that supports iCal subscriptions.</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-8">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-white d-flex align-items-center justify-content-between">
                    <h5 class="card-title mb-0">Upcoming Sessions</h5>
                    {% set currentDate = "now"|date('Y-m-d') %}
                    <a href="{{ path('app_calendar_day', {'year': currentDate|date('Y'), 'month': currentDate|date('m'), 'day': currentDate|date('d')}) }}" class="btn btn-sm btn-outline-primary">
                        Today's Schedule
                    </a>
                </div>
                <div class="card-body">
                    {% if sessions is empty %}
                        <div class="text-center py-5">
                            <div class="mb-4">
                                <i class="fas fa-calendar-plus display-1 text-muted"></i>
                            </div>
                            <h3>No Upcoming Sessions</h3>
                            <p class="text-muted mb-4">You don't have any upcoming sessions scheduled.</p>
                            <a href="{{ path('app_skills') }}" class="btn btn-primary">
                                <i class="fas fa-search me-2"></i>Find Skills to Learn
                            </a>
                        </div>
                    {% else %}
                        <div class="timeline">
                            {% for session in sessions %}
                                <div class="timeline-item">
                                    <div class="timeline-marker">
                                        <span class="date-badge">{{ session.dateTime|date('d') }}</span>
                                        <span class="month-badge">{{ session.dateTime|date('M') }}</span>
                                    </div>
                                    <div class="timeline-content">
                                        <div class="card border-0 mb-2 shadow-sm">
                                            <div class="card-body">
                                                <div class="session-time mb-2">
                                                    <i class="far fa-clock text-primary me-2"></i>{{ session.dateTime|date('g:i a') }}
                                                    {% if session.duration %}
                                                        <span class="text-muted">Â· {{ session.duration }} min</span>
                                                    {% endif %}
                                                </div>
                                                
                                                <h5 class="card-title mb-2">
                                                    {% if session.skill %}
                                                        {{ session.skill.name }} Session
                                                    {% else %}
                                                        Skill Exchange Session
                                                    {% endif %}
                                                </h5>
                                                
                                                <div class="participants mb-3">
                                                    <div class="d-flex align-items-center">
                                                        <!-- From User Avatar -->
                                                        <div class="avatar-small me-2">
                                                            {% if session.fromUser.avatar %}
                                                                <img src="{{ asset('uploads/avatars/' ~ session.fromUser.avatar) }}" alt="{{ session.fromUser.username }}" class="rounded-circle" width="24" height="24">
                                                            {% else %}
                                                                <div class="avatar-placeholder rounded-circle d-flex align-items-center justify-content-center" style="width: 24px; height: 24px;">
                                                                    {{ session.fromUser.username|first|upper }}
                                                                </div>
                                                            {% endif %}
                                                        </div>
                                                        
                                                        <!-- From Username -->
                                                        <span class="me-2">{{ session.fromUser.username }}</span>
                                                        
                                                        <i class="fas fa-exchange-alt text-muted mx-2"></i>
                                                        
                                                        <!-- To User Avatar -->
                                                        <div class="avatar-small me-2">
                                                            {% if session.toUser.avatar %}
                                                                <img src="{{ asset('uploads/avatars/' ~ session.toUser.avatar) }}" alt="{{ session.toUser.username }}" class="rounded-circle" width="24" height="24">
                                                            {% else %}
                                                                <div class="avatar-placeholder rounded-circle d-flex align-items-center justify-content-center" style="width: 24px; height: 24px;">
                                                                    {{ session.toUser.username|first|upper }}
                                                                </div>
                                                            {% endif %}
                                                        </div>
                                                        
                                                        <!-- To Username -->
                                                        <span>{{ session.toUser.username }}</span>
                                                    </div>
                                                </div>
                                                
                                                {% if session.location %}
                                                    <div class="location mb-3">
                                                        <i class="fas fa-map-marker-alt text-danger me-2"></i>{{ session.location }}
                                                    </div>
                                                {% endif %}
                                                
                                                <div class="status mb-3">
                                                    <span class="badge bg-{{ session.status == 'confirmed' ? 'success' : (session.status == 'pending' ? 'warning' : 'secondary') }}">
                                                        {{ session.status|capitalize }}
                                                    </span>
                                                </div>
                                                
                                                <div class="d-flex mt-3">
                                                    <a href="{{ path('app_session_view', {'id': session.id}) }}" class="btn btn-sm btn-outline-primary me-2">
                                                        <i class="fas fa-eye me-1"></i>Details
                                                    </a>
                                                    
                                                    {% if session.status == 'confirmed' %}
                                                        <a href="{{ path('app_session_calendar', {'id': session.id}) }}" class="btn btn-sm btn-outline-success me-2">
                                                            <i class="fas fa-calendar-plus me-1"></i>Add to Calendar
                                                        </a>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.timeline {
    position: relative;
    padding-left: 70px;
}

.timeline:before {
    content: '';
    position: absolute;
    left: 30px;
    top: 0;
    height: 100%;
    width: 4px;
    background: linear-gradient(to bottom, var(--primary-color), var(--secondary-color));
    border-radius: 4px;
}

.timeline-item {
    position: relative;
    margin-bottom: 30px;
}

.timeline-marker {
    position: absolute;
    left: -70px;
    display: flex;
    flex-direction: column;
    align-items: center;
    width: 60px;
}

.date-badge {
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
    color: white;
    font-weight: bold;
    font-size: 1.2rem;
    border-radius: 50%;
    z-index: 1;
}

.month-badge {
    font-size: 0.8rem;
    color: var(--text-muted);
    margin-top: 4px;
    font-weight: 600;
}

.avatar-placeholder {
    background-color: var(--primary-color);
    color: white;
    font-size: 0.8rem;
}
</style>

<script>
function copyCalendarUrl() {
    const copyText = document.getElementById("calendarUrl");
    copyText.select();
    copyText.setSelectionRange(0, 99999);
    navigator.clipboard.writeText(copyText.value);
    
    // Show copied message
    const button = copyText.nextElementSibling;
    const originalHtml = button.innerHTML;
    button.innerHTML = '<i class="fas fa-check"></i>';
    button.classList.add('btn-success');
    button.classList.remove('btn-outline-secondary');
    
    setTimeout(() => {
        button.innerHTML = originalHtml;
        button.classList.remove('btn-success');
        button.classList.add('btn-outline-secondary');
    }, 2000);
}
</script>
{% endblock %} 